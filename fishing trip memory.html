/** ========================
 *  FishLog Receiver + Photo Upload + Tide Chart save (Apps Script)
 * ======================== */

/* ===================== åŸºæœ¬è¨­å®š ===================== */
const SS_ID = ''; // ä¾‹: '1AbC...xyz'

// æ‰‹å‹•IDãŒæœªè¨­å®šã§ã‚‚ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«è‡ªå‹•ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆï¼‹æ°¸ç¶šåŒ–
const PHOTO_FOLDER_ID = '';              // é‡£æœå†™çœŸã®ä¿å­˜å…ˆï¼ˆç©ºã§ã‚‚OKï¼šè‡ªå‹•ã§ä½œæˆï¼‰
const TIDE_JSON_FOLDER_ID = '';          // æ½®æ±JSONã®ä¿å­˜å…ˆï¼ˆç©ºã§ã‚‚OKï¼šè‡ªå‹•ã§ä½œæˆï¼‰
const TIDE_CHART_IMAGES_FOLDER_ID = '';  // æ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒã®ä¿å­˜å…ˆï¼ˆç©ºã§ã‚‚OKï¼šè‡ªå‹•ã§ä½œæˆï¼‰
const TIDE_MAP_SHEET_NAME = 'æ½®æ±ãƒãƒ£ãƒ¼ãƒˆ';

/* ===================== ã‚¹ã‚­ãƒ¼ãƒ ===================== */
const SHEETS = {
    Trips: [
    'receivedAt','tripId','status','startedAt','endedAt',
    'pos_lat','pos_lng',
    'start_temp','start_wind_speed','start_wind_deg','start_weather_main','start_weather_desc',
    'end_temp','end_wind_speed','end_wind_deg','end_weather_main','end_weather_desc',
    'catches_count','tide_chart_images_count','raw_json',
    'moon_brightness','moon_age','moon_visual',
    'sunrise','sunset',
    'water_temp_c','water_temp_point','water_temp_time'
  ],
    Catches: [
    'receivedAt','tripId','catchId','timestamp','species',
    'size_cm','weight_g','method',
    'wx_temp','wx_wind_speed','wx_wind_deg','wx_main','wx_desc',
    'photo_file_id','photo_view_url','photo_thumb_url',
    'tide_level_cm','tide_trend','tide_name','tide_harbor_name',
    'tide_high_times','tide_low_times',
    'water_temp_c','water_temp_point','water_temp_time'
  ],
    TideChartImages: [
    'created_at','tripId','filename','timestamp','fileId','viewUrl','downloadUrl'
  ]
};



/* ===================== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== */
function getSs_() {
  try {
    // â˜…ä¿®æ­£ï¼šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ SPREADSHEET_ID ã‚’å„ªå…ˆçš„ã«å–å¾—
    const props = PropertiesService.getScriptProperties();
    const propId = (props.getProperty('SPREADSHEET_ID') || '').trim();
    if (propId) {
      return SpreadsheetApp.openById(propId);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šSS_ID ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    if (SS_ID && SS_ID.trim()) {
      return SpreadsheetApp.openById(SS_ID.trim());
    }
    
    // æœ€çµ‚æ‰‹æ®µï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
    return SpreadsheetApp.getActiveSpreadsheet();
  } catch (e) {
    throw new Error('Spreadsheet open failed: ' + e);
  }
}

function ensureSheets_() {
  const ss = getSs_();
  Object.entries(SHEETS).forEach(([name, headers]) => {
    let sh = ss.getSheetByName(name);
    if (!sh) {
      sh = ss.insertSheet(name);
      sh.getRange(1, 1, 1, headers.length).setValues([headers]);
      sh.setFrozenRows(1);
      return;
    }
    // ãƒ˜ãƒƒãƒ€ã‚’æœ€æ–°ã«æ•´ãˆã‚‹ï¼ˆä¸è¶³åˆ—ã¯å³ã«è¿½åŠ  / å·®åˆ†ã¯ä¸Šæ›¸ãï¼‰
    const lastCol = Math.max(sh.getLastColumn(), headers.length);
    if (lastCol < headers.length) sh.insertColumnsAfter(lastCol, headers.length - lastCol);
    const cur = sh.getRange(1,1,1,headers.length).getValues()[0];
    let diff = false;
    for (let i=0;i<headers.length;i++){ if (String(cur[i]||'')!==String(headers[i])) { diff=true; break; } }
    if (diff) sh.getRange(1,1,1,headers.length).setValues([headers]);
    sh.setFrozenRows(1);
  });
}

function ensureTideMapSheet_() {
  const ss = getSs_();
  let sh = ss.getSheetByName(TIDE_MAP_SHEET_NAME);
  const headers = [
    'created_at','tripId','startedAt','endedAt',
    'pref_code(pc)','harbor_code(hc)','pref_name','harbor_name',
    'chartDateKey','tideName','trendText','chartFileId','chartUrl'
  ];
  if (!sh) {
    sh = ss.insertSheet(TIDE_MAP_SHEET_NAME);
    sh.getRange(1,1,1,headers.length).setValues([headers]);
    sh.setFrozenRows(1);
  } else {
    const lastCol = Math.max(sh.getLastColumn(), headers.length);
    if (lastCol < headers.length) sh.insertColumnsAfter(lastCol, headers.length - lastCol);
    const cur = sh.getRange(1,1,1,headers.length).getValues()[0].map(String);
    const missing = headers.filter(h => cur.indexOf(h) === -1);
    if (missing.length > 0) {
      sh.getRange(1, cur.length + 1, 1, missing.length).setValues([missing]);
    }
    sh.setFrozenRows(1);
  }
  return sh;
}

function parseJson_(e) {
  if (!e || !e.postData || !e.postData.contents) throw new Error('No payload');
  try { return JSON.parse(e.postData.contents); }
  catch (err) { throw new Error('Invalid JSON: ' + err); }
}

function project_(obj, headers) { return headers.map(h => (obj[h] === undefined ? '' : obj[h])); }
function n_(v){ return (typeof v === 'number' && isFinite(v)) ? v : ''; }
function str_(v){ return (v == null) ? '' : String(v); }

function makeTripRow_(body, receivedAt){
  const start = body.start_weather || {};
  const end   = body.end_weather || {};
  const pos   = body.position || null;
  const t     = body.start_tide || {};
  const chart = t.chart || {};
  const sun   = t.sunrise || t.sunset ? {rise:t.sunrise, set:t.sunset} : (chart.sun || {});

  // â˜… ã“ã“ã‚’è¿½åŠ ï¼šstart_water_tempï¼ˆæ¨å¥¨ï¼‰ã¨æ—¢å­˜ãƒ•ãƒ©ãƒƒãƒˆã‚­ãƒ¼ã®ä¸¡å¯¾å¿œ
  const wtObj = body.start_water_temp || null;
  const wtC   = (wtObj && typeof wtObj.temperature_c === 'number')
                  ? wtObj.temperature_c
                  : body.water_temp_c;
  const wtPt  = (wtObj && wtObj.point_name) ? wtObj.point_name : body.water_temp_point;
  const wtTm  = (wtObj && wtObj.date)       ? wtObj.date       : body.water_temp_time;

  return {
    receivedAt,
    tripId: body.tripId || '',
    status: body.status || '',
    startedAt: body.startedAt || '',
    endedAt: body.endedAt || '',
    pos_lat: pos && typeof pos.lat === 'number' ? pos.lat : '',
    pos_lng: pos && typeof pos.lng === 'number' ? pos.lng : '',
    // æ—¢å­˜â€¦â€¦
    start_temp: n_(start.temp),
    start_wind_speed: n_(start.wind_speed),
    start_wind_deg: n_(start.wind_deg),
    start_weather_main: str_(start.weather_main),
    start_weather_desc: str_(start.weather_description),
    end_temp: n_(end.temp),
    end_wind_speed: n_(end.wind_speed),
    end_wind_deg: n_(end.wind_deg),
    end_weather_main: str_(end.weather_main),
    end_weather_desc: str_(end.weather_description),
    catches_count: Array.isArray(body.catches) ? body.catches.length : 0,
    // â˜…è¿½åŠ ï¼šæ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒæ•°
    tide_chart_images_count: Array.isArray(body.tide_chart_images) ? body.tide_chart_images.length : 0,
    raw_json: JSON.stringify(body),
    moon_brightness: n_(t.moon?.brightness),
    moon_age: n_(t.moon?.age),
    moon_visual: str_(t.moon ? moonVisual_(Number(t.moon.age), Number(t.moon.brightness)) : ''),
    // è¿½åŠ 
    sunrise: str_(sun.rise || ''),
    sunset:  str_(sun.set  || ''),
    // â˜… æ°´æ¸©ï¼ˆä¸¡æ–¹ã®å½¢å¼ã«å¯¾å¿œï¼‰
    water_temp_c: n_(wtC),
    water_temp_point: str_(wtPt),
    water_temp_time: str_(wtTm)
  };
}

function makeCatchRows_(body, receivedAt) {
  const tripId = body.tripId || '';
  const arr = Array.isArray(body.catches) ? body.catches : [];
  const startHarborName = body?.start_tide?.harbor?.hn || '';

  // â˜… è¿½è¨˜ï¼šãƒˆãƒªãƒƒãƒ—é–‹å§‹æ™‚ã®æ°´æ¸©ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
  const tripWT = body.start_water_temp || null;

  return arr.map(c => {
    // â˜…ä¿®æ­£ï¼šc.weather ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ãƒ•ãƒ©ãƒƒãƒˆå½¢å¼ã® wx_* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾å¿œ
    const wx = (c.weather && typeof c.weather === 'object') ? c.weather : {
      temp: c.wx_temp,
      wind_speed: c.wx_wind_speed,
      wind_deg: c.wx_wind_deg,
      weather_main: c.wx_main,
      weather_description: c.wx_desc
    };
    const photoFileId  = c.photoFileId || '';
    const viewUrl      = c.photoDriveUrl || '';
    const thumbUrl     = c.photoDriveThumbUrl || '';

    const tideLevel = (typeof c.tide_level_cm === 'number' && isFinite(c.tide_level_cm)) ? c.tide_level_cm : '';
    const tideTrend = str_(c.tide_trend);
    const tideName  = str_(c.tide_name);
    const tideHarborName = str_(c.tide_harbor_name || startHarborName);

    const highTimes = Array.isArray(c.tide_high_times) ? c.tide_high_times.join('ï¼') : str_(c.tide_high_times);
    const lowTimes  = Array.isArray(c.tide_low_times)  ? c.tide_low_times.join('ï¼')  : str_(c.tide_low_times);

    // â˜… è¿½è¨˜ï¼šã‚­ãƒ£ãƒƒãƒã«æ°´æ¸©ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã° trip ã®é–‹å§‹æ°´æ¸©ã€ã•ã‚‰ã«æ—§ãƒ•ãƒ©ãƒƒãƒˆã‚­ãƒ¼ã«ã‚‚å¯¾å¿œ
    const cWT = c.water_temp || null;
    const wtC  =
      (cWT && typeof cWT.temperature_c === 'number') ? cWT.temperature_c :
      (typeof c.water_temp_c === 'number') ? c.water_temp_c :
      (tripWT && typeof tripWT.temperature_c === 'number') ? tripWT.temperature_c : null;

    const wtPt =
      (cWT && cWT.point_name) ? cWT.point_name :
      (typeof c.water_temp_point === 'string') ? c.water_temp_point :
      (tripWT && tripWT.point_name) ? tripWT.point_name : null;

    const wtTm =
      (cWT && cWT.date) ? cWT.date :
      (typeof c.water_temp_time === 'string') ? c.water_temp_time :
      (tripWT && tripWT.date) ? tripWT.date : null;

    return {
      receivedAt,
      tripId,
      catchId: c.id || '',
      timestamp: c.timestamp || '',
      species: c.species || '',
      size_cm: n_(c.size_cm),
      weight_g: n_(c.weight_g),
      method: c.method || '',
      wx_temp: n_(wx.temp),
      wx_wind_speed: n_(wx.wind_speed),
      wx_wind_deg: n_(wx.wind_deg),
      wx_main: str_(wx.weather_main),
      wx_desc: str_(wx.weather_description),
      photo_file_id: photoFileId,
      photo_view_url: viewUrl,
      photo_thumb_url: thumbUrl,
      tide_level_cm: tideLevel,
      tide_trend: tideTrend,
      tide_name: tideName,
      tide_harbor_name: tideHarborName,
      tide_high_times: highTimes,
      tide_low_times:  lowTimes,
      water_temp_c: n_(wtC),
      water_temp_point: str_(wtPt),
      water_temp_time: str_(wtTm)
    };
  });
}

function jsonOutput_(obj, statusCode) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/** æœˆã®è¦‹ãŸç›®ï¼ˆçµµæ–‡å­—ï¼‰ã‚’è¿”ã™ã€‚age ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã° brightness(%)ã§æ¨å®š */
function moonVisual_(age, brightness){
  // age: 0-29 ãã‚‰ã„ã‚’æƒ³å®šã€‚null ã®å ´åˆã¯ brightness ã‹ã‚‰å¤§é›‘æŠŠã«æ¨å®š
  let a = (typeof age === 'number' && isFinite(age)) ? age : null;

  if (a == null && typeof brightness === 'number' && isFinite(brightness)) {
    // ã–ã£ãã‚Šæ¨å®šï¼š0=æ–°æœˆ, 14=æº€æœˆ
    const b = Math.max(0, Math.min(100, brightness));
    // 0..100 â†’ 0..14ï¼ˆæ–°â†’æº€ï¼‰
    const towardFull = Math.round(b / (100/14));
    // waning å´ã‹ã®åˆ¤å®šã¯é›£ã—ã„ã®ã§â€œæº€ã¡æ¬ ã‘æ–¹å‘â€ã¯ç„¡è¦–ã—ã€è¦‹ãŸç›®å„ªå…ˆ
    a = towardFull; // 0..14 ã®ç¯„å›²ã§ç–‘ä¼¼ age
  }

  if (a == null) return 'â€”';

  a = ((Math.floor(a) % 30) + 30) % 30; // 0-29 ã«æ­£è¦åŒ–
  if (a === 0) return 'ğŸŒ‘';                 // æ–°æœˆ
  if (a <= 6)  return 'ğŸŒ’';                 // ä¸‰æ—¥æœˆã€œ
  if (a <= 8)  return 'ğŸŒ“';                 // ä¸Šå¼¦
  if (a <= 13) return 'ğŸŒ”';                 // åä¸‰å¤œã€œ
  if (a === 14 || a === 15) return 'ğŸŒ•';    // æº€æœˆï¼ˆÂ±1 ã‚’æº€æœˆæ‰±ã„ï¼‰
  if (a <= 20) return 'ğŸŒ–';                 // åå…­å¤œã€œ
  if (a <= 22) return 'ğŸŒ—';                 // ä¸‹å¼¦
  return 'ğŸŒ˜';                              // æœ‰æ˜æœˆã€œ
}


/* ===================== Drive ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== */
function createOrGetFolderByName_(name, propKey){
  const props = PropertiesService.getScriptProperties();
  const saved = (props.getProperty(propKey) || '').trim();
  if (saved) {
    try { return DriveApp.getFolderById(saved); } catch(e){}
  }
  const it = DriveApp.getFoldersByName(name);
  if (it.hasNext()) {
    const f = it.next();
    props.setProperty(propKey, f.getId());
    return f;
  }
  const f = DriveApp.createFolder(name);
  props.setProperty(propKey, f.getId());
  return f;
}

function getPhotoFolder_() {
  const props = PropertiesService.getScriptProperties();
  const idDirect = (PHOTO_FOLDER_ID || '').trim() || (props.getProperty('PHOTO_FOLDER_ID') || '').trim();
  if (idDirect) {
    try { return DriveApp.getFolderById(idDirect); } catch(e){ }
  }
  return createOrGetFolderByName_('FishLog Photos', 'PHOTO_FOLDER_ID');
}

function getTideFolder_() {
  const props = PropertiesService.getScriptProperties();
  const idDirect = (TIDE_JSON_FOLDER_ID || '').trim() || (props.getProperty('TIDE_JSON_FOLDER_ID') || '').trim();
  if (idDirect) {
    try { return DriveApp.getFolderById(idDirect); } catch(e){ }
  }
  return createOrGetFolderByName_('FishLog Tide JSON', 'TIDE_JSON_FOLDER_ID');
}

function getTideChartImagesFolder_() {
  return createOrGetFolderByName_('FishLog Tide Chart Images', 'TIDE_CHART_IMAGES_FOLDER_ID');
}

function dataUrlToBlob_(dataUrl, mimeHint) {
  if (!dataUrl) return null;
  let mime = mimeHint || 'application/octet-stream';
  let b64 = dataUrl;
  const m = String(dataUrl).match(/^data:([^;,]+);base64,(.*)$/);
  if (m) { mime = m[1]; b64 = m[2]; }
  const bytes = Utilities.base64Decode(b64);
  return Utilities.newBlob(bytes, mime);
}

function makePublicAndUrls_(file) {
  try { file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch(e){}
  const id = file.getId();
  const viewUrl  = 'https://drive.google.com/uc?export=view&id=' + id;
  const thumbUrl = 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1200';
  return { id, viewUrl, thumbUrl };
}

/* ===================== æ½®æ±ãƒãƒ£ãƒ¼ãƒˆä¿å­˜ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰ ===================== */
function saveTideChartIfAny_(body) {
  const startTide = body?.start_tide || null;
  const chart     = startTide?.chart || null;
  if (!chart) return {};

  const tripId = body?.tripId || Utilities.getUuid();
  const chartDateKey = startTide?.chartDateKey || '';
  const dateForName = chartDateKey
    ? String(chartDateKey).replace(/[^\d-]/g,'').replace(/-/g,'')
    : Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyyMMdd');

  const fileName = `tidechart_${tripId}_${dateForName}.json`;
  const folder = getTideFolder_();
  const blob = Utilities.newBlob(JSON.stringify(chart), 'application/json', fileName);
  const file = folder.createFile(blob);
  const { id: fileId } = makePublicAndUrls_(file);
  const chartUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;

  const sh = ensureTideMapSheet_();
  sh.appendRow([
    new Date(),
    tripId,
    body?.startedAt || '',
    body?.endedAt   || '',
    startTide?.harbor?.pc || '',
    startTide?.harbor?.hc || '',
    startTide?.harbor?.pn || '',
    startTide?.harbor?.hn || '',
    chartDateKey,
    startTide?.tideName   || '',
    startTide?.trendText  || '',
    fileId,
    chartUrl
  ]);

  return { chartFileId: fileId, chartUrl };
}

/* ===================== æ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒä¿å­˜ ===================== */
function saveTideChartImages_(tripId, images, receivedAt) {
  if (!Array.isArray(images) || images.length === 0) {
    Logger.log("[saveTideChartImages_] no images to save");
    return { ok:false, count:0, reason:'no images' };
  }

  try {
    const ss = getSs_();
    const sh = ss.getSheetByName('TideChartImages');
    if (!sh) {
      Logger.log("[saveTideChartImages_] TideChartImages sheet not found");
      return { ok:false, count:0, reason:'sheet not found' };
    }

    let savedCount = 0;
    const createdAt = receivedAt || new Date().toISOString();

    for (const img of images) {
      try {
        Logger.log("[saveTideChartImages_] saving image: filename=%s timestamp=%s fileId=%s", img.filename, img.timestamp, img.fileId);
        
        sh.appendRow([
          createdAt,                    // created_at
          tripId,                       // tripId (å¤–éƒ¨ã‚­ãƒ¼)
          img.filename || '',           // filename
          img.timestamp || '',          // timestamp
          img.fileId || '',             // fileId
          img.viewUrl || '',            // viewUrl
          img.downloadUrl || ''         // downloadUrlï¼ˆæœªè¨­å®šã®å ´åˆã¯ç©ºï¼‰
        ]);
        
        savedCount++;
        Logger.log("[saveTideChartImages_] saved: %d/%d", savedCount, images.length);
      } catch (rowErr) {
        Logger.log("[saveTideChartImages_] row append error: %s", String(rowErr));
      }
    }

    Logger.log("[saveTideChartImages_] completed: tripId=%s savedCount=%d", tripId, savedCount);
    return { ok:true, count:savedCount };

  } catch (err) {
    Logger.log("[saveTideChartImages_] error: %s", String(err));
    return { ok:false, count:0, reason:String(err) };
  }
}

/* ===================== Web ã‚¢ãƒ—ãƒª ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ===================== */
function doPost(e) {
  try {
    const type = e?.postData?.type || '';
    const len  = e?.postData?.contents ? String(e.postData.contents).length : 0;
    Logger.log("[doPost] type=%s len=%s", type, len);
    var head = '';
    try { head = String(e.postData.contents || '').slice(0, 800); } catch(_){}
    Logger.log("[doPost] head=%s", head);

    let parsed = {};
    try { parsed = JSON.parse(e.postData.contents || '{}'); }catch(_){}

    // 1) å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    if (parsed && parsed.action === 'uploadPhoto') {
      Logger.log("[doPost] branch=uploadPhoto");
      const fileName = (parsed.fileName || ('photo_' + Date.now() + '.jpg')).replace(/[\/\\]/g, '_');
      const mimeType = parsed.mimeType || 'image/jpeg';
      const blob =
        dataUrlToBlob_(parsed.dataUrl, mimeType) ||
        dataUrlToBlob_(('data:' + mimeType + ';base64,' + (parsed.base64 || '')), mimeType);
      if (!blob) return jsonOutput_({ ok:false, error:'no image payload (dataUrl/base64 missing)' }, 400);

      const folder = getPhotoFolder_();
      blob.setName(fileName);
      const file = folder.createFile(blob);
      const urls = makePublicAndUrls_(file);
      Logger.log("[doPost] photo: saved fileId=%s", urls.id);
      return jsonOutput_({ ok:true, fileId: urls.id, viewUrl: urls.viewUrl, thumbUrl: urls.thumbUrl }, 200);
    }

    // 1.5) æ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    if (parsed && parsed.action === 'uploadTideImage') {
      Logger.log("[doPost] branch=uploadTideImage");
      const fileName = (parsed.fileName || ('tideimage_' + Date.now() + '.png')).replace(/[\/\\]/g, '_');
      const mimeType = parsed.mimeType || 'image/png';
      const blob =
        dataUrlToBlob_(parsed.dataUrl, mimeType) ||
        dataUrlToBlob_(('data:' + mimeType + ';base64,' + (parsed.base64 || '')), mimeType);
      if (!blob) return jsonOutput_({ ok:false, error:'no image payload (dataUrl/base64 missing)' }, 400);

      const folder = getTideChartImagesFolder_();
      blob.setName(fileName);
      const file = folder.createFile(blob);
      const urls = makePublicAndUrls_(file);
      Logger.log("[doPost] tideimage: saved fileId=%s", urls.id);
      return jsonOutput_({ ok:true, fileId: urls.id, viewUrl: urls.viewUrl, thumbUrl: urls.thumbUrl }, 200);
    }

    // 1.6) æ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒãƒ—ãƒ­ã‚­ã‚·å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼†å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
    if (parsed && parsed.action === 'fetchTideImageViaProxy') {
      Logger.log("[doPost] branch=fetchTideImageViaProxy");
      const filename = parsed.fileName || parsed.filename || '';
      if (!filename) return jsonOutput_({ ok:false, error:'filename is required' }, 400);

      try {
        const baseUrl = 'https://www.mirc.jha.or.jp/online/w/w-tcp/img/akashi/';
        const imageUrl = baseUrl + filename;
        Logger.log("[doPost] fetchTideImageViaProxy: url=%s", imageUrl);

        // URLFetchAppã§ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰å–å¾—ï¼ˆGASã¯CORSã«åˆ¶é™ã•ã‚Œãªã„ï¼‰
        const options = {
          muteHttpExceptions: true,
          followRedirects: true,
          timeout: 30
        };
        const response = UrlFetchApp.fetch(imageUrl, options);
        const statusCode = response.getResponseCode();
        
        if (statusCode !== 200) {
          Logger.log("[doPost] fetchTideImageViaProxy: failed, status=%d", statusCode);
          return jsonOutput_({ ok:false, error:`HTTP ${statusCode}: failed to fetch image from source` }, 400);
        }

        const blob = response.getBlob();
        const blobSize = blob.getBytes().length;
        Logger.log("[doPost] fetchTideImageViaProxy: blob size=%d bytes", blobSize);

        if (blobSize === 0) {
          return jsonOutput_({ ok:false, error:'downloaded blob is empty' }, 400);
        }

        // Google Driveã«ä¿å­˜
        const folder = getTideChartImagesFolder_();
        const file = folder.createFile(blob);
        file.setName(filename);
        const urls = makePublicAndUrls_(file);
        
        Logger.log("[doPost] fetchTideImageViaProxy: saved fileId=%s", urls.id);
        return jsonOutput_({ ok:true, fileId: urls.id, viewUrl: urls.viewUrl }, 200);
      } catch (err) {
        Logger.log("[doPost] fetchTideImageViaProxy: error=%s stack=%s", String(err), err.stack || '');
        return jsonOutput_({ ok:false, error:String(err) }, 500);
      }
    }

    // 2) é‡£è¡Œãƒ‡ãƒ¼ã‚¿ä¿å­˜
    Logger.log("[doPost] branch=tripSave");
    ensureSheets_();

    let body;
    try { body = parseJson_(e); }
    catch (pe) { return jsonOutput_({ ok:false, error:"invalid JSON payload for tripSave" }, 400); }

    const receivedAt = new Date().toISOString();
    if (!body.tripId) return jsonOutput_({ ok:false, error:'tripId is required' }, 400);
    if (!Array.isArray(body.catches)) body.catches = [];

    // â˜…è¿½åŠ ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆæ–°è¦ä½œæˆ or æ›´æ–°ï¼‰
    const action = body?.action || 'create';  // â˜…ä¿®æ­£ï¼šparsed ã§ã¯ãªã body ã‹ã‚‰å–å¾—
    Logger.log("[doPost] action=%s", action);
    
    if (action === 'update') {
      // æ—¢å­˜é‡£è¡Œãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      return updateTripData(body, receivedAt);
    } else {
      // æ–°è¦é‡£è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      return createTripData(body, receivedAt);
    }
  } catch (err) {
    Logger.log("[doPost] FATAL %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

/* ===================== CORS ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆå¯¾å¿œ ===================== */
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON);
}

/* ===================== é‡£è¡Œãƒ‡ãƒ¼ã‚¿æ–°è¦ä½œæˆ ===================== */
function createTripData(body, receivedAt) {
  try {
    const ss = getSs_();
    const tripObj = makeTripRow_(body, receivedAt);
    ss.getSheetByName('Trips').appendRow(project_(tripObj, SHEETS.Trips));

    const catchObjs = makeCatchRows_(body, receivedAt);
    if (catchObjs.length > 0) {
      const sh = ss.getSheetByName('Catches');
      const rows = catchObjs.map(o => project_(o, SHEETS.Catches));
      sh.getRange(sh.getLastRow()+1, 1, rows.length, rows[0].length).setValues(rows);
    }

    // æ½®æ±ãƒãƒ£ãƒ¼ãƒˆä¿å­˜
    let tideSave = {};
    try { tideSave = saveTideChartIfAny_(body); }
    catch (te) { Logger.log("[doPost] tide save error=%s", String(te)); }

    // æ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒä¿å­˜
    let imageSave = { ok:false, count:0 };
    try { imageSave = saveTideChartImages_(body.tripId, body.tide_chart_images || [], receivedAt); }
    catch (ie) { Logger.log("[createTripData] image save error=%s", String(ie)); }

    Logger.log("[createTripData] tripId=%s catches=%d images=%d", body.tripId, catchObjs.length, imageSave.count);
    return jsonOutput_({
      ok: true,
      action: 'create',
      saved: { trips:1, catches:catchObjs.length, images:imageSave.count },
      chartFileId: tideSave.chartFileId || null,
      chartUrl: tideSave.chartUrl || null
    }, 200);

  } catch (err) {
    Logger.log("[createTripData] error=%s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

/* ===================== é‡£è¡Œãƒ‡ãƒ¼ã‚¿æ›´æ–° ===================== */
function updateTripData(body, receivedAt) {
  try {
    const tripId = body.tripId;
    Logger.log("[updateTripData] tripId=%s", tripId);

    const ss = getSs_();
    const tripsSheet = ss.getSheetByName('Trips');
    const catchesSheet = ss.getSheetByName('Catches');

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—1ï¼šTripsã‚·ãƒ¼ãƒˆã‹ã‚‰æ—¢å­˜è¡Œã‚’æ¤œç´¢
    const allTripsData = tripsSheet.getDataRange().getValues();
    const tripIdColIndex = SHEETS.Trips.indexOf('tripId');
    
    let tripRowIndex = -1;
    for (let i = 1; i < allTripsData.length; i++) {  // ãƒ˜ãƒƒãƒ€è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (String(allTripsData[i][tripIdColIndex]) === String(tripId)) {
        tripRowIndex = i + 1;  // Sheets ã¯ 1-indexed
        break;
      }
    }

    if (tripRowIndex === -1) {
      Logger.log("[updateTripData] tripId not found: %s", tripId);
      return jsonOutput_({ ok:false, error:'tripId not found in Trips sheet' }, 404);
    }

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—2ï¼šTripsè¡Œã‚’æ›´æ–°
    const tripObj = makeTripRow_(body, receivedAt);
    const tripRow = project_(tripObj, SHEETS.Trips);
    tripsSheet.getRange(tripRowIndex, 1, 1, tripRow.length).setValues([tripRow]);
    Logger.log("[updateTripData] trip row updated at row %d", tripRowIndex);

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæ—¢å­˜ã®é‡£æœã‚’å‰Šé™¤ã—ã¦æ–°è¦è¿½åŠ 
    // æ—¢å­˜é‡£æœã‚’æ¤œç´¢
    const allCatchesData = catchesSheet.getDataRange().getValues();
    const catchTripIdColIndex = SHEETS.Catches.indexOf('tripId');
    const rowsToDelete = [];
    
    for (let i = allCatchesData.length - 1; i >= 1; i--) {  // é€†é †ã§å‰Šé™¤
      if (String(allCatchesData[i][catchTripIdColIndex]) === String(tripId)) {
        rowsToDelete.push(i + 1);  // Sheets ã¯ 1-indexed
      }
    }

    // é€†é †ã§å‰Šé™¤ï¼ˆè¡Œç•ªå·ã®ã‚ºãƒ¬ã‚’é˜²ãï¼‰
    rowsToDelete.sort((a, b) => b - a);
    rowsToDelete.forEach(rowNum => {
      catchesSheet.deleteRow(rowNum);
    });
    Logger.log("[updateTripData] deleted %d old catch rows", rowsToDelete.length);

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—4ï¼šæ–°è¦é‡£æœã‚’è¿½åŠ 
    const catchObjs = makeCatchRows_(body, receivedAt);
    let catchesAdded = 0;
    if (catchObjs.length > 0) {
      const rows = catchObjs.map(o => project_(o, SHEETS.Catches));
      catchesSheet.getRange(catchesSheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
      catchesAdded = rows.length;
    }
    Logger.log("[updateTripData] added %d new catch rows", catchesAdded);

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—5ï¼šæ½®æ±ãƒãƒ£ãƒ¼ãƒˆä¿å­˜ï¼ˆå·®åˆ†æ›´æ–°ï¼‰
    let tideSave = {};
    try { tideSave = saveTideChartIfAny_(body); }
    catch (te) { Logger.log("[updateTripData] tide save error=%s", String(te)); }

    // â˜…ã‚¹ãƒ†ãƒƒãƒ—5.5ï¼šæ½®æ±ãƒãƒ£ãƒ¼ãƒˆç”»åƒä¿å­˜
    let imageSave = { ok:false, count:0 };
    try { imageSave = saveTideChartImages_(tripId, body.tide_chart_images || [], receivedAt); }
    catch (ie) { Logger.log("[updateTripData] image save error=%s", String(ie)); }

    Logger.log("[updateTripData] completed: tripId=%s images=%d", tripId, imageSave.count);
    return jsonOutput_({
      ok: true,
      action: 'update',
      saved: { trips:1, catches: catchesAdded, images: imageSave.count },
      deleted_catches: rowsToDelete.length,
      chartFileId: tideSave.chartFileId || null,
      chartUrl: tideSave.chartUrl || null
    }, 200);

  } catch (err) {
    Logger.log("[updateTripData] error=%s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

function doGet(e) {
  try {
    const action = (e?.parameter?.action || '').trim();
    const sheetName = (e?.parameter?.sheetName || '').trim();
    const sheetId = (e?.parameter?.sheetId || '').trim();
    
    if (action === 'getSheetData' && sheetName) {
      return getSheetDataProxy_(sheetName, sheetId);
    }
    
    if (action === 'getSheetConfig' || action === 'getConfig') {
      return getConfigProxy_();
    }
    
    if (action === 'setTripsSpreadsheetId' && e?.parameter?.spreadsheetId) {
      return setTripsSpreadsheetIdProxy_(e.parameter.spreadsheetId);
    }
    
    if (action === 'setCatchesSpreadsheetId' && e?.parameter?.spreadsheetId) {
      return setCatchesSpreadsheetIdProxy_(e.parameter.spreadsheetId);
    }
    
    if (action === 'setSpreadsheetId' && e?.parameter?.spreadsheetId) {
      return setSpreadsheetIdProxy_(e.parameter.spreadsheetId);
    }
    
    ensureSheets_();
    ensureTideMapSheet_();
    return jsonOutput_({ ok:true, message:'fishlog receiver alive' }, 200);
  } catch (err) {
    Logger.log("[doGet] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

/* ===================== ãƒ˜ãƒ«ãƒ‘ï¼ˆä»»æ„ï¼‰ ===================== */
function setSpreadsheetIdProxy_(spreadsheetId) {
  try {
    if (!spreadsheetId || !String(spreadsheetId).trim()) {
      return jsonOutput_({ ok:false, error:'spreadsheetId is required' }, 400);
    }
    const props = PropertiesService.getScriptProperties();
    props.setProperty('SPREADSHEET_ID', String(spreadsheetId).trim());
    Logger.log("[setSpreadsheetIdProxy_] saved spreadsheetId: %s", spreadsheetId);
    return jsonOutput_({ ok:true, message:'spreadsheetId saved' }, 200);
  } catch (err) {
    Logger.log("[setSpreadsheetIdProxy_] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

function setTripsSpreadsheetIdProxy_(spreadsheetId) {
  try {
    if (!spreadsheetId || !String(spreadsheetId).trim()) {
      return jsonOutput_({ ok:false, error:'spreadsheetId is required' }, 400);
    }
    const props = PropertiesService.getScriptProperties();
    // çµ±ä¸€ã•ã‚ŒãŸ SPREADSHEET_ID ã«ä¿å­˜
    props.setProperty('SPREADSHEET_ID', String(spreadsheetId).trim());
    Logger.log("[setTripsSpreadsheetIdProxy_] saved SPREADSHEET_ID: %s", spreadsheetId);
    return jsonOutput_({ ok:true, message:'SPREADSHEET_ID saved' }, 200);
  } catch (err) {
    Logger.log("[setTripsSpreadsheetIdProxy_] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

function setCatchesSpreadsheetIdProxy_(spreadsheetId) {
  try {
    if (!spreadsheetId || !String(spreadsheetId).trim()) {
      return jsonOutput_({ ok:false, error:'spreadsheetId is required' }, 400);
    }
    const props = PropertiesService.getScriptProperties();
    // çµ±ä¸€ã•ã‚ŒãŸ SPREADSHEET_ID ã«ä¿å­˜
    props.setProperty('SPREADSHEET_ID', String(spreadsheetId).trim());
    Logger.log("[setCatchesSpreadsheetIdProxy_] saved SPREADSHEET_ID: %s", spreadsheetId);
    return jsonOutput_({ ok:true, message:'SPREADSHEET_ID saved' }, 200);
  } catch (err) {
    Logger.log("[setCatchesSpreadsheetIdProxy_] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

function getConfigProxy_() {
  try {
    const props = PropertiesService.getScriptProperties();
    // çµ±ä¸€ã•ã‚ŒãŸ SPREADSHEET_ID ã‚’è¿”ã™
    let sheetId = props.getProperty('SPREADSHEET_ID') || '';
    
    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæœªè¨­å®šã®å ´åˆã¯ã€å®Ÿè¡Œä¸­ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®IDã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨
    if (!sheetId) {
      try {
        sheetId = SpreadsheetApp.getActiveSpreadsheet().getId();
        Logger.log("[getConfigProxy_] using active spreadsheet ID as default: %s", sheetId);
      } catch (e) {
        Logger.log("[getConfigProxy_] cannot get active spreadsheet: %s", String(e));
      }
    }
    
    return jsonOutput_({ ok: sheetId ? true : false, sheetId: sheetId }, 200);
  } catch (err) {
    Logger.log("[getConfigProxy_] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 400);
  }
}

function getSheetDataProxy_(sheetName, sheetId) {
  try {
    const props = PropertiesService.getScriptProperties();
    
    // sheetId ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ SPREADSHEET_ID ã‚’ä½¿ç”¨
    const spreadsheetId = (sheetId && sheetId.trim()) || props.getProperty('SPREADSHEET_ID') || '';
    
    if (!spreadsheetId) {
      return jsonOutput_({ ok:false, error:`spreadsheetId is not configured` }, 400);
    }
    
    let ss;
    try {
      ss = SpreadsheetApp.openById(spreadsheetId);
    } catch (err) {
      return jsonOutput_({ ok:false, error:'Cannot open spreadsheet: ' + String(err) }, 403);
    }
    
    const sh = ss.getSheetByName(sheetName);
    if (!sh) {
      return jsonOutput_({ ok:false, error:'Sheet not found: ' + sheetName }, 404);
    }
    
    const data = sh.getDataRange().getValues();
    Logger.log("[getSheetDataProxy_] sheetName=%s rows=%d spreadsheetId=%s", sheetName, data.length, spreadsheetId.substring(0, 10));
    
    return jsonOutput_({ ok:true, data: data }, 200);
  } catch (err) {
    Logger.log("[getSheetDataProxy_] error: %s", String(err));
    return jsonOutput_({ ok:false, error:String(err) }, 500);
  }
}

function buildTripPayloadFromDraft(d){
  return {
    tripId: d.tripId,
    status: d.status,
    startedAt: d.startedAt || null,
    endedAt: d.endedAt || null,
    position: (typeof d.lat==='number' && typeof d.lng==='number') ? { lat: d.lat, lng: d.lng } : null,
    start_weather: d.start_weather || null,
    end_weather: d.end_weather || null,
    start_tide: d.start_tide || null,
    // â˜… æ–°è¦è¿½åŠ ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆã«ä¿æŒã—ã¦ã„ã‚‹é–‹å§‹æ™‚æ°´æ¸©ã‚’ã€ãƒ•ãƒ­ãƒ³ãƒˆã®é€ä¿¡å½¢å¼ã«åˆã‚ã›ã¦ä»˜ä¸ï¼‰
    water_temp_c: d.start_water_temp && typeof d.start_water_temp.temperature_c === 'number' ? d.start_water_temp.temperature_c : null,
    water_temp_point: d.start_water_temp && d.start_water_temp.point_name ? d.start_water_temp.point_name : null,
    water_temp_time: d.start_water_temp && d.start_water_temp.date ? d.start_water_temp.date : null,
    catches: (d.catches||[]).map(c => ({
      id: c.id,
      timestamp: c.timestamp || null,
      species: c.species || '',
      size_cm: (typeof c.size_cm==='number') ? c.size_cm : null,
      weight_g:(typeof c.weight_g==='number')? c.weight_g: null,
      method: c.method || '',
      weather: c.weather || null,
      tide_level_cm: (typeof c.tide_level_cm === 'number' && isFinite(c.tide_level_cm)) ? c.tide_level_cm : null,
      tide_trend: c.tide_trend || null,
      tide_name: c.tide_name || null,
      tide_harbor_name: c.tide_harbor_name || null,
      // â–¼ ã“ã“ã‚’è¿½åŠ ï¼šæº€æ½®/å¹²æ½®ã‚‚é€šã™
      tide_high_times: Array.isArray(c.tide_high_times) ? c.tide_high_times.join('ï¼') : (c.tide_high_times || null),
      tide_low_times:  Array.isArray(c.tide_low_times)  ? c.tide_low_times.join('ï¼')  : (c.tide_low_times  || null),

      photoFileId: c.photoFileId || '',
      photoDriveUrl: c.photoDriveUrl || '',
      photoDriveThumbUrl: c.photoDriveThumbUrl || ''
    }))
  };
}
